/*
 * Copyright 2012 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package org.atmosphere.samples.chat;

import org.atmosphere.config.service.WebSocketHandlerService;
import org.atmosphere.cpr.AtmosphereResource;
import org.atmosphere.cpr.AtmosphereResourceEvent;
import org.atmosphere.cpr.AtmosphereResourceEventListenerAdapter;
import org.atmosphere.cpr.Broadcaster;
import org.atmosphere.cpr.BroadcasterFactory;
import org.atmosphere.util.SimpleBroadcaster;
import org.atmosphere.websocket.WebSocket;
import org.atmosphere.websocket.WebSocketHandler;
import org.atmosphere.websocket.WebSocketHandlerAdapter;
import org.codehaus.jackson.map.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Date;

/**
 * Simple {@link WebSocketHandler} that implement the logic to build a Chat application.
 * 
 * @author Jeanfrancois Arcand
 */
@WebSocketHandlerService(path = "/chat", broadcaster = SimpleBroadcaster.class)
public class WebSocketChat extends WebSocketHandlerAdapter
{

   private final Logger logger = LoggerFactory.getLogger(WebSocketChat.class);
   private final ObjectMapper mapper = new ObjectMapper();

   @Override
   public void onOpen(WebSocket webSocket) throws IOException
   {
      webSocket.resource().setBroadcaster(BroadcasterFactory.getDefault().lookup("/chat", true));
      webSocket.resource().addEventListener(new AtmosphereResourceEventListenerAdapter()
      {
         @Override
         public void onDisconnect(AtmosphereResourceEvent event)
         {
            if (event.isCancelled())
            {
               logger.info("Browser {} unexpectedly disconnected", event.getResource().uuid());
            }
            else if (event.isClosedByClient())
            {
               logger.info("Browser {} closed the connection", event.getResource().uuid());
            }
         }
      });
   }

   @Override
   public void onTextMessage(WebSocket webSocket, String message) throws IOException
   {
      AtmosphereResource r = webSocket.resource();
      Broadcaster b = r.getBroadcaster();
      b.broadcast(mapper.writeValueAsString(mapper.readValue(message, Data.class)));
   }

   public final static class Data
   {

      private String message;
      private String author;
      private long time;

      public Data()
      {
         this("", "");
      }

      public Data(String author, String message)
      {
         this.author = author;
         this.message = message;
         this.time = new Date().getTime();
      }

      public String getMessage()
      {
         return message;
      }

      public String getAuthor()
      {
         return author;
      }

      public void setAuthor(String author)
      {
         this.author = author;
      }

      public void setMessage(String message)
      {
         this.message = message;
      }

      public long getTime()
      {
         return time;
      }

      public void setTime(long time)
      {
         this.time = time;
      }

   }
}
